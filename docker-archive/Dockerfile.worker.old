FROM node:18-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl wget git python3 python3-pip dnsutils nmap unzip chromium \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy and install dependencies
COPY package*.json ./
RUN npm install --legacy-peer-deps

# Copy source code
COPY . .

# Build TypeScript
RUN npm run build || npx tsc || true

# Install security tools
RUN curl -L https://github.com/projectdiscovery/nuclei/releases/download/v3.0.4/nuclei_3.0.4_linux_amd64.zip -o nuclei.zip \
    && unzip -o nuclei.zip && mv nuclei /usr/local/bin/ && rm nuclei.zip

# Set environment
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# Copy worker to root for easier access
RUN if [ -f "apps/workers/dist/worker-pubsub.js" ]; then cp apps/workers/dist/worker-pubsub.js .; fi

# Run the Pub/Sub worker  
CMD ["node", "worker-pubsub.js"]